<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volunteer Events</title>
    <style>
        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            font-family: Arial, sans-serif;
        }

        /* Table Header Styles */
        thead th {
            background-color: #4CAF50;
            color: white;
            padding: 12px 15px;
            text-align: left;
        }

        /* Table Row Styles */
        tbody tr {
            border-bottom: 1px solid #ddd;
        }

        tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        tbody td {
            padding: 10px 15px;
        }

        /* Button Styles */
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 8px 16px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        /* Signup Form Styles */
        .signup-form-row {
            display: none;
        }

        .signup-form-row.active {
            display: table-row;
        }

        .signup-form {
            background-color: #f9f9f9;
            padding: 15px;
        }

        .signup-form input, 
        .signup-form textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Location Filter Styles */
        #location-filter {
            width: 200px;
            padding: 8px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <h1>Volunteer Events</h1>

    <!-- Location Filter -->
    <label for="location-filter">Filter by Location:</label>
    <select id="location-filter">
        <option value="">All Locations</option>
        <% 
        // Create a Set of unique locations to avoid duplicates
        const uniqueLocations = new Set(event.map(row => `${row.event_city}, ${row.event_state}`));
        uniqueLocations.forEach(location => { 
        %>
            <option value="<%= location %>"><%= location %></option>
        <% }); %>
    </select>


    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Date</th>
                <th>City</th>
                <th>State</th>
                <th>Start Time</th>
                <th>End Time</th>
                <th>Event Type</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <% if (event.length > 0) { %>
                <% event.forEach((row, index) => { %>
                    <tr class="event-row" 
                        data-location="<%= `${row.event_city}, ${row.event_state}` %>"
                        data-event-id="<%= row.event_id %>"
                    >
                        <input type="hidden" value="<%= row.event_id %>">
                        <td><%= row.event_name %></td>
                        <td><%= new Date(row.event_date).toLocaleDateString() %></td>
                        <td><%= row.event_city %></td>
                        <td><%= row.event_state %></td>
                        <td>
                            <% 
                            const startTimeString = row.event_start_time.split('+')[0];
                            %>
                            <%= startTimeString %>
                        </td>
                        <td>
                            <%
                            const endTimeString = row.event_end_time.split('+')[0];
                            %>
                            <%= endTimeString %>
                        </td>
                        <td><%= row.event_type %></td>
                        <td>
                            <button class="signup-btn">Volunteer Signup</button>
                        </td>
                    </tr>
                    <tr class="signup-form-row">
                        <td colspan="9">
                            
                            <div class="signup-form">
                                <h3>Volunteer Signup for <%= row.event_name %></h3>
                                <form class="volunteer-signup-form">
                                    <input type="hidden" name="eventId" value="<%= row.event_id %>">
                                    
                                    
                                    <div class="event-location">
                                        <strong>Event Location:</strong>
                                        <p><%= `${row.event_address}, ${row.event_zipcode}` %></p>
                                    </div>

                                    <div class="num-sewing-machines-needed">
                                        <strong>Number of sewing machines needed:</strong>
                                        <p><%= row.num_sewing_machines_needed %></p>
                                    </div>
                                    <div class="num-sergers-needed">
                                        <strong>Number of sergers needed:</strong>
                                        <p><%= row.num_sergers_needed %></p>
                                    </div>


                                    
                                    <div>
                                        <label>Additional Notes</label>
                                        <textarea name="notes" rows="3"></textarea>
                                    </div>
                                    <button type="submit">Submit Signup</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                <% }); %>
            <% } else { %>
                <tr>
                    <td colspan="9">No events available</td>
                </tr>
            <% } %>
        </tbody>
    </table>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const signupButtons = document.querySelectorAll('.signup-btn');
            const locationFilter = document.getElementById('location-filter');

            // Event signup toggle
            signupButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const row = e.target.closest('.event-row');
                    const signupFormRow = row.nextElementSibling;
                    
                    // Hide all other signup forms
                    document.querySelectorAll('.signup-form-row').forEach(formRow => {
                        if (formRow !== signupFormRow) {
                            formRow.style.display = 'none';
                        }
                    });

                    // Toggle current signup form
                    signupFormRow.style.display = 
                        signupFormRow.style.display === 'table-row' ? 'none' : 'table-row';
                });
            });

            // Location filtering
            locationFilter.addEventListener('change', (e) => {
                const selectedLocation = e.target.value;
                const eventRows = document.querySelectorAll('.event-row');

                eventRows.forEach(row => {
                    if (selectedLocation === '' || row.dataset.location === selectedLocation) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });

            // Form submission
            document.querySelectorAll('.volunteer-signup-form').forEach(form => {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const data = Object.fromEntries(formData.entries());

                    try {
                        const response = await fetch('/api/volunteer-signup', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(data)
                        });

                        if (response.ok) {
                            alert('Successfully signed up!');
                            e.target.closest('.signup-form-row').style.display = 'none';
                        } else {
                            alert('Error signing up. Please try again.');
                        }
                    } catch (error) {
                        alert('Error signing up. Please try again.');
                        console.error('Signup error:', error);
                    }
                });
            });
        });
    </script>
</body>
</html>